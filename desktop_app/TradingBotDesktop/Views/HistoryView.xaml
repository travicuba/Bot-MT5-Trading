<Page x:Class="TradingBotDesktop.Views.HistoryView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      Background="{StaticResource SecondaryBgBrush}"
      Title="Historial">

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Titulo + botones -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Column="0" Text="Historial de Trades"
                       Style="{StaticResource PageTitle}" Margin="0"/>
            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock x:Name="TotalCount" Text="0 trades"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center" Margin="0,0,16,0"/>
                <Button Content="Actualizar" Style="{StaticResource SecondaryButton}"
                        Click="BtnRefresh_Click" Margin="0,0,8,0"/>
                <Button Content="Exportar CSV" Style="{StaticResource SecondaryButton}"
                        Click="BtnExport_Click"/>
            </StackPanel>
        </Grid>

        <!-- Filtros -->
        <Border Grid.Row="1" Style="{StaticResource CardPanel}" Margin="0,0,0,16">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Resultado:" VerticalAlignment="Center"
                           Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,8,0"/>
                <ComboBox x:Name="FilterResult" Width="120"
                          SelectionChanged="Filter_Changed">
                    <ComboBoxItem Content="Todos" IsSelected="True"/>
                    <ComboBoxItem Content="WIN"/>
                    <ComboBoxItem Content="LOSS"/>
                    <ComboBoxItem Content="BREAKEVEN"/>
                </ComboBox>
                <TextBlock Text="Mostrar:" VerticalAlignment="Center"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           Margin="16,0,8,0"/>
                <ComboBox x:Name="FilterLimit" Width="100"
                          SelectionChanged="Filter_Changed">
                    <ComboBoxItem Content="50"  IsSelected="True"/>
                    <ComboBoxItem Content="100"/>
                    <ComboBoxItem Content="200"/>
                    <ComboBoxItem Content="500"/>
                </ComboBox>
            </StackPanel>
        </Border>

        <!-- Tabla de historial -->
        <Border Grid.Row="2" Style="{StaticResource CardPanel}" Padding="0">
            <DataGrid x:Name="HistoryGrid" AutoGenerateColumns="False"
                      BorderThickness="0">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Fecha/Hora"  Binding="{Binding Timestamp}"  Width="150"/>
                    <DataGridTextColumn Header="Estrategia"  Binding="{Binding SetupName}"  Width="*"/>
                    <DataGridTextColumn Header="Simbolo"     Binding="{Binding Symbol}"     Width="90"/>
                    <DataGridTextColumn Header="Accion"      Binding="{Binding Action}"     Width="70"/>
                    <DataGridTemplateColumn Header="Resultado" Width="100">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border>
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Result}" Value="WIN">
                                                    <Setter Property="Background" Value="#1A3FB950"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Result}" Value="LOSS">
                                                    <Setter Property="Background" Value="#1AF85149"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="{Binding ResultDisplay}"
                                               HorizontalAlignment="Center"
                                               Margin="4,2">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground"
                                                        Value="{StaticResource TextPrimaryBrush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Result}" Value="WIN">
                                                        <Setter Property="Foreground"
                                                                Value="{StaticResource SuccessBrush}"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Result}" Value="LOSS">
                                                        <Setter Property="Foreground"
                                                                Value="{StaticResource ErrorBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="Pips" Binding="{Binding Pips, StringFormat=F1}" Width="80"/>
                </DataGrid.Columns>
            </DataGrid>
        </Border>
    </Grid>
</Page>
